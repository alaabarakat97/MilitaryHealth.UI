<div class="supervisor-page container-fluid">
  <div class="row justify-content-center mb-3">
    <div class="col-12 col-md-6">
      <div class="search-wrapper">
        <button class="btn search-btn" (click)="loadApplicants()">
          <i class="fas fa-search"></i>
          <span>ابحث</span>
        </button>
        <input type="text" class="form-control search-input" placeholder="ابحث عن رقم الملف..." dir="rtl"
          [(ngModel)]="searchValue">
      </div>
      <div *ngIf="!applicant && responseMessage" class="alert alert-warning mt-3" role="alert">
        {{ responseMessage }}
      </div>
    </div>
  </div>

  <div class="row g-2 mt-2" *ngIf="applicant">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">البيانات الشخصية والطبية</h5>
        </div>
        <div class="card-body py-2">
          <div class="row row-cols-2 row-cols-md-4 g-2 compact-grid">
            <div class="col-6 col-md-3">
              <strong>رقم الملف: </strong> <span>{{ applicant.fileNumber }}</span>
            </div>
            <div class="col-6 col-md-3">
              <strong>الاسم: </strong> <span>{{ applicant.fullName }}</span>
            </div>
            <div class="col-6 col-md-3">
              <strong>الحالة الاجتماعية: </strong> <span>{{ getMaritalStatusDescription(applicant.maritalStatusID) }}</span>
            </div>
            <div class="col-6 col-md-3">
              <strong>الوظيفة: </strong> <span>{{ applicant.job }}</span>
            </div>
            <div class="col-6 col-md-3">
              <strong>الطول: </strong> <span>{{ applicant.height }} سم</span>
            </div>
            <div class="col-6 col-md-3">
              <strong>الوزن: </strong> <span>{{ applicant.weight }} كجم</span>
            </div>
            <div class="col-6 col-md-3">
              <strong>BMI: </strong> <span>{{ applicant.bmi }}</span>
            </div>
            <div class="col-6 col-md-3">
              <strong>ضغط الدم: </strong> <span>{{ applicant.bloodPressure }}</span>
            </div>
            <div class="col-6 col-md-3">
              <strong>النبض: </strong> <span>{{ applicant.pulse }}</span>
            </div>
            <div class="col-6 col-md-3">
              <strong>وشم: </strong> <span>{{ applicant.tattoo ? 'يوجد' : 'لا يوجد' }}</span>
            </div>
            <div class="col-12">
              <strong>علامات مميزة: </strong> <span>{{ applicant.distinctiveMarks || 'لا توجد' }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-12 mt-4">
      <div class="card shadow-sm">
        <div class="card-header bg-dark text-white">
          <h5 class="mb-0">الفحوصات الطبية</h5>
        </div>
        <div class="card-body py-2">
          <div class="row row-cols-1 row-cols-md-2 g-2">
            <div class="col">
              <div class="border rounded p-2 small compact-exam-card">
                <h6 class="text-info mb-2">👁️ فحص العيون</h6>
                <ng-container *ngIf="applicant.eyeExam; ">
                  <div><strong>النظر:</strong> {{ applicant.eyeExam.vision }}</div>
                  <div><strong>الألوان:</strong> {{ applicant.eyeExam.colorTest }}</div>
                  <div><strong>قيمة الانكسار:</strong> {{ applicant.eyeExam.refractionValue }}</div>
                  <div><strong>النتيجة:</strong> {{ getResultDescription(applicant.eyeExam.resultID) }}</div>
                </ng-container>
              </div>
            </div>
            
            <div class="col">
              <div class="border rounded p-2 small compact-exam-card">
                <h6 class="text-warning mb-2">🩺 الفحص الجراحي</h6>
                <ng-container *ngIf="applicant.surgicalExam; else noData">
                  <div><strong>عام:</strong> {{ applicant.surgicalExam.generalSurgery }}</div>
                  <div><strong>المسالك البولية:</strong> {{ applicant.surgicalExam.urinarySurgery }}</div>
                  <div><strong>الأوعية الدموية:</strong> {{ applicant.surgicalExam.vascularSurgery }}</div>
                  <div><strong>الصدر:</strong> {{ applicant.surgicalExam.thoracicSurgery }}</div>
                  <div><strong>النتيجة:</strong> {{ getResultDescription(applicant.surgicalExam.resultID) }}</div>
                </ng-container>
              </div>
            </div>
            
            <div class="col">
              <div class="border rounded p-2 small compact-exam-card">
                <h6 class="text-danger mb-2">❤️ الفحص الباطني</h6>
                <ng-container *ngIf="applicant.internalExam; else noData">
                  <div><strong>القلب:</strong> {{ applicant.internalExam.heart }}</div>
                  <div><strong>الجهاز التنفسي:</strong> {{ applicant.internalExam.respiratory }}</div>
                  <div><strong>الجهاز الهضمي:</strong> {{ applicant.internalExam.digestive }}</div>
                  <div><strong>الغدد الصماء:</strong> {{ applicant.internalExam.endocrine }}</div>
                  <div><strong>الأعصاب:</strong> {{ applicant.internalExam.neurology }}</div>
                  <div><strong>الدم:</strong> {{ applicant.internalExam.blood }}</div>
                  <div><strong>المفاصل:</strong> {{ applicant.internalExam.joints }}</div>
                  <div><strong>الكلى:</strong> {{ applicant.internalExam.kidney }}</div>
                  <div><strong>السمع:</strong> {{ applicant.internalExam.hearing }}</div>
                  <div><strong>الجلد:</strong> {{ applicant.internalExam.skin }}</div>
                  <div><strong>النتيجة:</strong> {{ getResultDescription(applicant.internalExam.resultID) }}</div>
                </ng-container>
              </div>
            </div>
            
            <div class="col">
              <div class="border rounded p-2 small compact-exam-card">
                <h6 class="text-secondary mb-2">🦴 فحص العظام</h6>
                <ng-container *ngIf="applicant.orthopedicExamDto; else noData">
                  <div><strong>عضلي هيكلي:</strong> {{ applicant.orthopedicExamDto.musculoskeletal }}</div>
                  <div><strong>جراحة عصبية:</strong> {{ applicant.orthopedicExamDto.neurologicalSurgery }}</div>
                  <div><strong>النتيجة:</strong> {{ getResultDescription(applicant.orthopedicExamDto.resultID) }}</div>
                </ng-container>
              </div>
            </div>
            
            <div class="col">
              <div class="border rounded p-2 small compact-exam-card">
                <h6 class="text-dark mb-2">📑 الاستشارة</h6>
                <ng-container *ngIf="applicant.consultation; else noData">
                  <div><strong>النوع:</strong> {{ applicant.consultation.consultationType }}</div>
                  <div><strong>الطبيب:</strong> {{ applicant.consultation.referredDoctor }}</div>
                </ng-container>
              </div>
            </div>
            
            <ng-template #noData>
              <div class="text-muted">لا يوجد بيانات</div>
            </ng-template>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-12 mt-4">
      <div class="card shadow-sm">
        <div class="card-header bg-dark text-white">
          <h5 class="mb-0">القرار النهائي</h5>
        </div>
        <div class="card-body py-2">
          <form #decisionForm="ngForm">
            <div class="mb-3">
              <label class="form-label">النتيجة</label>
              <ng-select [items]="results" bindLabel="description" bindValue="resultID"
                [(ngModel)]="decisionModel.resultID" name="resultID" (ngModelChange)="onResultChange($event)"
                placeholder="اختر النتيجة" [appendTo]="'body'">
              </ng-select>
            </div>
            
            <div class="mb-3">
              <label class="form-label">السبب</label>
              <textarea class="form-control" [(ngModel)]="decisionModel.reason" name="reason"></textarea>
            </div>
            @if(!isApproved){
            <div class="mb-3">
              <label class="form-label">مدة التأجيل</label>
              <input type="text" class="form-control" [(ngModel)]="decisionModel.postponeDuration"
                name="postponeDuration" />
            </div>
            }
            <div class="text-end">
              <button type="button" class="btn btn-primary" (click)="submitDecision()">
                <i class="fas fa-paper-plane"></i> إرسال
              </button>
            </div>
            <div *ngIf="responseMessage" class="mt-3">
              <div class="alert" [ngClass]="{'alert-success': responseSuccess, 'alert-danger': !responseSuccess}"
                role="alert">
                {{ responseMessage }}
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>